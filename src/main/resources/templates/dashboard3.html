<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: commonHead"></head>
  <meta charset="UTF-8">
  <title>ëŒ€ì‹œë³´ë“œ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .subscription-list { margin-top: 20px; }
    .subscription-item { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .add-button, .edit-button { margin-top: 10px; padding: 5px 10px; font-size: 16px; }
    .notification-link { margin-top: 40px; font-size: 14px; color: #666; }
  </style>
  <script>
    function toggleDeleteMode() {
      const checkboxes = document.querySelectorAll('.delete-checkbox');
      const deleteBtn = document.getElementById('delete-selected-btn');
      checkboxes.forEach(cb => cb.style.display = cb.style.display === 'inline' ? 'none' : 'inline');
      deleteBtn.style.display = deleteBtn.style.display === 'inline' ? 'none' : 'inline';
    }

    function toggleComparisonChart() {
      const chartDiv = document.getElementById('comparisonChartWrapper');
      chartDiv.style.display = chartDiv.style.display === 'none' ? 'block' : 'none';
    }
  </script>
<body>
<h2 th:text="'í™˜ì˜í•©ë‹ˆë‹¤, ' + ${session.userNickname} + 'ë‹˜!'"></h2>

<div class="subscription-list">
  <div th:if="${subscriptions.size() == 0}">
    <p>êµ¬ë… ëª©ë¡ ì—†ìŒ</p>
  </div>

  <div>
    <h3>ğŸ“Š ì´ë²ˆ ë‹¬ ì´ êµ¬ë… ê¸ˆì•¡: <span th:text="${totalAmount}">0</span>ì›</h3>
    <h4>ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„</h4>
    <ul>
      <li th:each="entry : ${categoryTotals}">
        <span th:text="${entry.key}">ì¹´í…Œê³ ë¦¬</span>: <span th:text="${entry.value}">0</span>ì›
      </li>
    </ul>

    <!-- âœ… ì°¨íŠ¸ 2ê°œ ê°€ë¡œ ë°°ì¹˜ -->
    <div style="display: flex; gap: 30px; margin-top: 30px;">
      <div style="width: 400px; height: 300px;">
        <h4 style="text-align: center;">ğŸ“Š ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ì¹´í…Œê³ ë¦¬</h4>
        <canvas id="categoryChart"></canvas>
      </div>

      <div style="width: 400px; height: 300px;">
        <h4 style="text-align: center;">ğŸ¥§ ê°€ì¥ ë§ì€ ë¹„ìš©ì„ ì°¨ì§€í•˜ëŠ” ì¹´í…Œê³ ë¦¬</h4>
        <canvas id="categoryPieChart"></canvas>
      </div>
    </div>

    <!-- âœ… ğŸ“‰ ë¹„êµ ë²„íŠ¼ ë° ê·¸ë˜í”„ -->
    <button onclick="toggleComparisonChart()" style="margin-top: 30px;">ğŸ“‰ ì§€ë‚œë‹¬ vs ì´ë²ˆë‹¬ ë¹„êµ ë³´ê¸°</button>
    <div id="comparisonChartWrapper" style="display: none; margin-top: 10px;">
      <h4>ğŸ“‰ ì´ë²ˆ ë‹¬ vs ì§€ë‚œ ë‹¬ ë¹„êµ</h4>
      <canvas id="monthlyComparisonChart" width="400" height="200"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      document.addEventListener('DOMContentLoaded', function () {
        const categoryData = /*[[${categoryTotals}]]*/ {};
        const labels = Object.keys(categoryData);
        const data = Object.values(categoryData);

        const ctxBar = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctxBar, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'êµ¬ë… ê¸ˆì•¡ (â‚©)',
              data: data,
              backgroundColor: 'rgba(75, 192, 192, 0.5)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: false,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });

        const ctxPie = document.getElementById('categoryPieChart').getContext('2d');
        new Chart(ctxPie, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              label: 'ë¹„ìš© ë¹„ìœ¨',
              data: data,
              backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: false,
            maintainAspectRatio: false
          }
        });

        const monthlyComparisonData = /*[[${monthlyComparison}]]*/ {};
        const months = Object.keys(monthlyComparisonData);
        const values = Object.values(monthlyComparisonData);

        const ctxLine = document.getElementById('monthlyComparisonChart').getContext('2d');
        new Chart(ctxLine, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'ì´ êµ¬ë… ê¸ˆì•¡ ë¹„êµ (â‚©)',
              data: values,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
      });
      /*]]>*/
    </script>
  </div>

  <!-- âœ… êµ¬ë… ëª©ë¡ -->
  <!-- âœ… êµ¬ë… ëª©ë¡ ì¶œë ¥ (ì •ëˆëœ í…Œì´ë¸”) -->
  <form th:action="@{/subscriptions/delete-many}" method="post">
    <div th:if="${subscriptions.size() > 0}">
      <table style="width: 100%; border-collapse: collapse;">
        <thead style="background-color: #f0f0f0; text-align: left;">
        <tr>
          <th style="padding: 8px;">ì„œë¹„ìŠ¤ëª…</th>
          <th style="padding: 8px;">ê²°ì œì¼</th>
          <th style="padding: 8px;">ê¸ˆì•¡(â‚©)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="sub : ${subscriptions}" style="border-bottom: 1px solid #ccc;">
          <td style="padding: 8px;" th:text="${sub.service_name}">ì„œë¹„ìŠ¤ëª…</td>
          <td style="padding: 8px;" th:text="${sub.payment_day}">ê²°ì œì¼</td>
          <td style="padding: 8px;">
            <span th:text="${sub.amount}">ê¸ˆì•¡</span> ì›
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top: 10px;">
      <button type="button" class="edit-button" onclick="toggleDeleteMode()">ìˆ˜ì •</button>
      <button type="submit" id="delete-selected-btn" style="display: none;">ì„ íƒ ì‚­ì œ</button>
    </div>
  </form>



  <form th:action="@{/subscriptions/register}" method="get">
    <button type="submit" class="add-button">+ êµ¬ë… ì¶”ê°€</button>
  </form>
</div>

<a th:href="@{/notifications}">
  ğŸ”” ì•Œë¦¼ ë³´ê¸°
  <span th:if="${unreadCount > 0}" th:text="'(' + ${unreadCount} + ')'"> </span>
</a>

<div class="notification-link">
  <a th:href="@{/mypage}">ğŸ™‹ ë§ˆì´í˜ì´ì§€</a>
</div>

<form th:action="@{/users/logout}" method="post">
  <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
</form>
</body>
</html>
